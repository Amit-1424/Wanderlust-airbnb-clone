<% layout("/layouts/boilerplate") %>
<div class="container mt-4">
  <div class="row">

    <!-- LEFT SIDE -->
    <div class="col-md-9">

      <!-- IMAGE -->
      <div class="show-image-card shadow-sm">
        <img 
          src="<%= listing.image?.url || '/default.jpg' %>" 
          class="show-img"
          alt="listing image"
        >
      </div>

      <!-- DETAILS -->
      <div class="show-details-card shadow-sm mt-3 p-4">
        <h3 class="fw-bold"><%= listing.title %></h3>
        <p> owner:  <i><%=listing.owner.username   %></i>  </p>
        <p class="text-muted">
          <%= listing.location %>, <%= listing.country %>
        </p>

        <h4>
          &#8377 <%= listing.price.toLocaleString("en-IN") %>
        </h4>

        <hr>

        <p><%= listing.description %></p>

        <% if(currUser && currUser._id.equals(listing.owner._id)) { %>
        <div class="d-flex gap-3 mt-3">
          <a href="/listings/<%= listing._id %>/edit"
            class="btn btn-outline-dark rounded-pill px-4">
            Edit
          </a>

          <form method="POST"
            action="/listings/<%= listing._id %>?_method=DELETE">
            <button class="btn btn-danger rounded-pill px-4">
              Delete
            </button>
          </form>
        </div>
        <% } %>

      </div>

      <!-- FUTURE MAP SECTION -->
      <!-- You will add map here later -->

    </div>


    <!-- RIGHT SIDE -->
    <div class="col-md-3">

      <!-- ADD REVIEW -->
      <div class="review-card shadow-sm p-3 mb-4">
        <h5>Add Review</h5>

        <form method="POST" action="/listings/<%= listing._id %>/reviews">

          <label class="form-label">
            Rating: <span id="rating-value">3</span> ⭐
          </label>

          <input 
            type="range"
            name="review[rating]"
            class="form-range"
            min="1"
            max="5"
            value="3"
            oninput="document.getElementById('rating-value').innerText = this.value"
          >

          <div class="mb-3 mt-2">
            <label>Comment</label>
            <textarea
              name="review[comment]"
              class="form-control"
              rows="3"
              placeholder="Write your review..."
              required
            ></textarea>
          </div>

          <button class="btn btn-dark w-100 rounded-pill">
            Submit Review
          </button>
        </form>
      </div>


      <!-- ALL REVIEWS -->
      <div class="all-reviews mt-4">

  <h6 class="mb-3">All Reviews</h6>

  <% if (listing.review && listing.review.length > 0) { %>

    <% listing.review.forEach(r => { %>

      <div class="card review-card mb-3 shadow-sm">
        <div class="card-body p-3">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-bold text-warning">
              <%= r.rating %> ⭐
            </span>

            <small class="text-muted">
              <%= r.created_at ? r.created_at.toDateString() : "" %>
            </small>
          </div>

          <p class="card-text mb-0">
            <%= r.comment %>
          </p>

        </div>
        <form method="post" action="/listings/<%= listing._id  %>/reviews/<%= r._id  %>?_method=DELETE"  >
          <button class="btn btn-sm btn-dark btn-review" >Delete</button>
        </form>
      </div>

    <% }) %>

  <% } else { %>

    <p class="text-muted small">No reviews yet.</p>

  <% } %>

</div>

    </div>

  </div>
</div>